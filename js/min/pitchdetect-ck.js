function error(){alert("Stream generation failed.")}function getUserMedia(e,t){try{navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia(e,t,error)}catch(n){alert("getUserMedia threw exception :"+n)}}function gotStream(e){var t=audioContext.createMediaStreamSource(e);analyser=audioContext.createAnalyser(),analyser.fftSize=2048,t.connect(analyser),updatePitch()}function togglePlayback(){var e=audioContext.currentTime;return isPlaying?(sourceNode.stop(e),sourceNode=null,analyser=null,isPlaying=!1,window.cancelAnimationFrame||(window.cancelAnimationFrame=window.webkitCancelAnimationFrame),window.cancelAnimationFrame(rafID),"start"):(sourceNode=audioContext.createBufferSource(),sourceNode.buffer=theBuffer,sourceNode.loop=!0,analyser=audioContext.createAnalyser(),analyser.fftSize=2048,sourceNode.connect(analyser),analyser.connect(audioContext.destination),sourceNode.start(e),isPlaying=!0,isLiveInput=!1,updatePitch(),"stop")}function noteFromPitch(e){var t=12*(Math.log(e/440)/Math.log(2));return Math.round(t)+69}function frequencyFromNoteNumber(e){return 440*Math.pow(2,(e-69)/12)}function centsOffFromPitch(e,t){return 1200*Math.log(e/frequencyFromNoteNumber(t))/Math.log(2)}function autoCorrelate(e,t){var n=4,r=1e3,a=1e3,o=-1,i=0,c=0;if(confidence=0,currentPitch=0,!(e.length<a+r-n)){for(var u=0;a>u;u++){var l=(e[u]-128)/128;c+=l*l}c=Math.sqrt(c/a);for(var d=n;r>=d;d++){for(var s=0,u=0;a>u;u++)s+=Math.abs((e[u]-128)/128-(e[u+d]-128)/128);s=1-s/a,s>i&&(i=s,o=d)}c>.01&&i>.01&&(confidence=i*c*1e4,currentPitch=t/o)}}function updatePitch(e){var t=new Array;if(analyser.getByteTimeDomainData(buf),autoCorrelate(buf,audioContext.sampleRate),canvasContext.clearRect(0,0,WIDTH,HEIGHT),10>confidence)detectorElem.className="vague",pitchElem.innerText="--",noteElem.innerText="-",detuneElem.className="",detuneAmount.innerText="--";else{detectorElem.className="confident",pitchElem.innerText=Math.floor(currentPitch);var n=noteFromPitch(currentPitch);noteElem.innerHTML=noteStrings[n%12];var r=centsOffFromPitch(currentPitch,n);0==r?(detuneElem.className="",detuneAmount.innerHTML="--"):(canvasContext.fillStyle=Math.abs(r)<10?"green":"red",detuneElem.className=0>r?"flat":"sharp",canvasContext.fillRect(CENTER,0,3*r,HEIGHT),detuneAmount.innerHTML=Math.abs(Math.floor(r)))}window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame),rafID=window.requestAnimationFrame(updatePitch)}window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=new AudioContext,isPlaying=!1,sourceNode=null,analyser=null,theBuffer=null,detectorElem,canvasContext,pitchElem,noteElem,detuneElem,detuneAmount,WIDTH=300,CENTER=150,HEIGHT=42,confidence=0,currentPitch=0;window.onload=function(){detectorElem=document.getElementById("detector"),pitchElem=document.getElementById("pitch"),noteElem=document.getElementById("note"),detuneElem=document.getElementById("detune"),detuneAmount=document.getElementById("detune_amt"),canvasContext=document.getElementById("output").getContext("2d"),detectorElem.ondragenter=function(){return this.classList.add("droptarget"),!1},detectorElem.ondragleave=function(){return this.classList.remove("droptarget"),!1},detectorElem.ondrop=function(e){this.classList.remove("droptarget"),e.preventDefault(),theBuffer=null;var t=new FileReader;return t.onload=function(e){audioContext.decodeAudioData(e.target.result,function(e){theBuffer=e},function(){alert("error loading!")})},t.onerror=function(e){alert("Error: "+t.error)},t.readAsArrayBuffer(e.dataTransfer.files[0]),!1},Init()};var rafID=null,tracks=null,buflen=2048,buf=new Uint8Array(buflen),MINVAL=134,noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];