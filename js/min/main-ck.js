function Render(){if(window.requestAnimationFrame(Render),sample_buffer.IsFilled()){for(var e=sample_buffer.size,t=new Float32Array(2*e),o=0;e>o;++o)t[2*o+0]=sample_buffer.Get(o),t[2*o+1]=0;for(var o=0;e>o;++o)x=2*Math.PI*o/(fft_size-1),w=.54-.46*Math.cos(x),t[2*o+0]*=w,t[2*o+1]*=w;fft.Forward(t);var a=audio_context.sampleRate/e,n=Math.pow(2,1/1200),r=10,i=Math.pow(n,r),s=1200*Math.log(min_freq)/log2,c=1200*Math.log(max_freq)/log2,l=c-s,u=30,d=15;first?ctx.clearRect(0,0,canvas.width,canvas.height):ctx.clearRect(u-2,d-2,canvas.width-2*u+4,canvas.height-2*d+4),ctx.beginPath(),ctx.lineWidth="1";for(var f=min_freq,o=0;max_freq>=f;f*=i,++o){var g=Math.floor(f/a);re=t[g<<1],im=t[g<<1|1],fftMagSq=Math.pow(re/e,2)+Math.pow(im/e,2),x=o*r/l*(canvas.width-2*u)+u,dB=20*Math.log(fftMagSq/1e-5)/log10,dB_cutoff>dB&&(dB=dB_cutoff),M=(.4*(dB/dB_cutoff-1)+1)*(canvas.height-1.5*d),f==min_freq?ctx.moveTo(x,M):ctx.lineTo(x,M)}if(ctx.stroke(),first){var m=1200*Math.log(16.35)/log2;ctx.font=d.toString()+"px Arial",ctx.textBaseline="top",ctx.textAlign="center";for(var o=1,h=s;c+10>h;h+=100)var v=Math.round((h-m)/1200),p=Math.round((h-m)%1200/100)%12,_=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","H"],x=(h-s)/l*(canvas.width-2*u)+u,M=canvas.height-d,A=_[p]+String.fromCharCode(8320+v)}first=!1}}function StartProcessing(e){gotStream(e),message.innerHTML="",source=audio_context.createMediaStreamSource(e),processor=audio_context.createScriptProcessor(block_size,1,1),processor.onaudioprocess=function(e){sample_buffer.Push(e.inputBuffer.getChannelData(0))},source.connect(processor),processor.connect(audio_context.destination),Render()}function Init(){message=document.querySelector("#message"),canvas=document.querySelector("#canvas"),canvas.width=window.innerWidth,canvas.height=window.innerHeight/2,ctx=canvas.getContext("2d");try{audio_context=new AudioContext}catch(e){return console.log("The Web Audio API is apparently not supported in this browser. ",e),void(message.innerHTML="The Web Audio API is apparently not supported in this browser.")}message.innerHTML="To continue, please allow the application to access the audio capture device.",navigator.getUserMedia({audio:!0},StartProcessing,function(e){console.log("navigator.getUserMedia error: ",e),message.innerHTML="navigator.getUserMedia error: "+e.name})}var message=null,canvas=null,ctx=null,audio_context=null,processor=null,source=null,block_size=512,num_blocks=32,sample_buffer=new Float32CyclicBuffer(block_size,num_blocks),fft_size=num_blocks*block_size,fft=new FFTAlgorithm(fft_size),log2=Math.log(2),log10=Math.log(10),min_freq=261.63,max_freq=2093,dB_cutoff=-170;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;var AudioContext=AudioContext||webkitAudioContext||mozAudioContext,first=!0;